"use strict";

var spawn = require('child_process').spawn;
var kill = require('tree-kill');
var gpio = require('rpi-gpio');
var path = require('path');

var method = Emitter.prototype;


function Emitter(freq,ps,rt) {

    this.freq = freq;
    this.ps = ps;
    this.rt = rt;
    this.pid = null;

}

method.start = function() {
    var cPath = path.join(__dirname, "node_modules" ,"PiFmRds", "src", "pi_fm_rds");
    var myProcess = spawn(
        'sudo',
        [cPath,'-freq', this.freq, '-ps', this.ps, '-rt', this.rt, '-audio', '-'],
        { stdio: ['pipe', 1, 2, 'ipc'] }
    );
    console.log("Broadcasting, process :", myProcess.pid);
    this.pid = myProcess.pid;
    return myProcess.stdin;
};

method.stop = function() {
    if (this.pid > 0){
        kill(this.pid, 'SIGINT');
        this.cleanGpio(4);
    } else {
        console.log("could not kill signal whose pid is not an integer");
        this.cleanGpio(4);
    };
};


method.cleanGpio = function(number) {
    try {
        gpio.setup(4, gpio.DIR_OUT);
        gpio.destroy(function() {
            console.log("Pin 4 unexported");
        });
    } catch(err) {
        console.log(err);
    }
};


module.exports = Emitter;

